{% extends 'app/base.html' %}
{% load static %}
{% block title %}Gi·ªè h√†ng{% endblock title %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/cart.css' %}">
<style>
    /* CSS t√πy ch·ªânh nh·ªè ƒë·ªÉ cƒÉn ch·ªânh checkbox ƒë·∫πp h∆°n */
    .cart-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .delete-btn {
        cursor: pointer;
        transition: color 0.2s;
    }
    .delete-btn:hover {
        color: #dc3545 !important; /* M√†u ƒë·ªè khi hover */
    }
</style>
{% endblock extra_css %}

{% block cart_content %}
<div class="container my-5">
    <div class="row">

        <div class="col-lg-8">
            <h3 class="mb-4 fw-bold text-dark">üõí Gi·ªè h√†ng c·ªßa b·∫°n (<span id="cart-total-product-count">{{order.get_cart_items}}</span> s·∫£n ph·∫©m)</h3>

            <a class="btn btn-outline-secondary btn-sm mb-3" href="{% url 'home' %}">
                <i class="fas fa-arrow-left me-2"></i> Ti·∫øp t·ª•c mua s·∫Øm
            </a>

            <div class="box-element cart-list-container bg-white border rounded shadow-sm">

                {% if items %}
                <div class="cart-table-header d-flex text-uppercase small border-bottom py-2 fw-bold text-muted">
                    <div class="col-1 text-center d-flex align-items-center justify-content-center">
                        <input type="checkbox" id="select-all" class="cart-checkbox" checked>
                    </div>
                    <div class="col-4 ps-2">S·∫£n ph·∫©m</div>
                    <div class="col-2 text-center">ƒê∆°n gi√°</div>
                    <div class="col-3 text-center">S·ªë l∆∞·ª£ng</div>
                    <div class="col-1 text-center">T·ªïng</div>
                    <div class="col-1 text-center">X√≥a</div>
                </div>

                <div id="cart-items-list">
                    {% for item in items %}
                    <div class="cart-row d-flex align-items-center border-bottom py-3 item-row"
                         data-price="{{item.get_total}}"> <div class="col-1 text-center d-flex align-items-center justify-content-center">
                            <input type="checkbox"
                                   class="item-checkbox cart-checkbox"
                                   name="selected_items"
                                   value="{{item.product.id}}"
                                   checked>
                        </div>

                        <div class="col-4 d-flex align-items-center ps-2">
                            <img class="product-image rounded me-3"
                                 style="width: 50px; height: 50px; object-fit: cover;"
                                 src="{{item.product.get_image_url}}"
                                 alt="{{item.product.name}}">
                            <div>
                                <p class="product-name fw-bold mb-0 text-dark small text-truncate" style="max-width: 150px;">{{item.product.name}}</p>
                            </div>
                        </div>

                        <div class="col-2 text-center">
                            <p class="price-text mb-0 text-muted small">{{item.product.price|floatformat:0|intcomma}}‚Ç´</p>
                        </div>

                        <div class="col-3 text-center">
                            <div class="d-flex justify-content-center align-items-center quantity-group mx-auto">
                                <button class="btn btn-sm btn-light border update-cart"
                                        data-product="{{item.product.id}}"
                                        data-action="remove">
                                    <i class="fas fa-minus small"></i>
                                </button>
                                <span class="quantity-value mx-2 fw-bold" id="quantity-{{item.product.id}}">{{item.quantity}}</span>
                                <button class="btn btn-sm btn-light border update-cart"
                                        data-product="{{item.product.id}}"
                                        data-action="add">
                                    <i class="fas fa-plus small"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-1 text-center px-0">
                            <p class="total-text mb-0 fw-bold text-dark small">{{item.get_total|floatformat:0|intcomma}}‚Ç´</p>
                        </div>

                        <div class="col-1 text-center">
                            <button class="btn btn-link text-secondary p-0 delete-item-btn delete-cart-item"
                                    data-product="{{item.product.id}}"
                                    title="X√≥a s·∫£n ph·∫©m">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <div class="empty-cart text-center p-5">
                    <div class="display-1 text-muted">üõí</div>
                    <p class="h4 mt-3 mb-4 empty-cart-text text-muted">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
                    <a class="btn btn-danger btn-lg" href="{% url 'home' %}">
                        <i class="fas fa-search me-2"></i> Kh√°m ph√° s·∫£n ph·∫©m ngay
                    </a>
                </div>
                {% endif %}

            </div>
        </div>

        <div class="col-lg-4 cart-summary-sidebar">
            <div class="box-element p-4 rounded shadow-sm bg-white border">
                <h4 class="fw-bold mb-4 border-bottom pb-3">üìù T·ªïng k·∫øt ƒë∆°n h√†ng</h4>

                <div class="d-flex justify-content-between mb-3 small text-muted">
                    <span>S·ªë l∆∞·ª£ng ƒë√£ ch·ªçn:</span>
                    <span class="fw-bold text-dark" id="selected-count">{{order.get_cart_items}} s·∫£n ph·∫©m</span>
                </div>

                <div class="d-flex justify-content-between mb-3 small text-muted">
                    <span>T·∫°m t√≠nh:</span>
                    <span class="fw-bold text-dark" id="subtotal-price">{{order.get_cart_total|floatformat:0|intcomma}}‚Ç´</span>
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-4">
                    <span class="h5 fw-bold text-uppercase">T·ªîNG TI·ªÄN:</span>
                    <span class="total-price-text text-danger h4" id="final-total">{{order.get_cart_total|floatformat:0|intcomma}}‚Ç´</span>
                </div>

                <button id="checkout-btn" class="btn btn-danger btn-lg w-100 fw-bold">
                    <i class="fas fa-money-check-alt me-2"></i> MUA H√ÄNG
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectedCountSpan = document.getElementById('selected-count');
        const subtotalSpan = document.getElementById('subtotal-price');
        const finalTotalSpan = document.getElementById('final-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const deleteButtons = document.querySelectorAll('.delete-cart-item');

        // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá (VD: 100000 -> 100,000‚Ç´)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
        }

        // H√†m t√≠nh l·∫°i t·ªïng ti·ªÅn d·ª±a tr√™n checkbox
        function updateSummary() {
            let total = 0;
            let count = 0;

            itemCheckboxes.forEach(cb => {
                if (cb.checked) {
                    // T√¨m d√≤ng ch·ª©a checkbox n√†y ƒë·ªÉ l·∫•y gi√° ti·ªÅn
                    const row = cb.closest('.item-row');
                    const price = parseFloat(row.getAttribute('data-price').replace(',', '.')); // ƒê·∫£m b·∫£o ƒë√∫ng format s·ªë
                    total += price;
                    count += 1; // Ho·∫∑c count += quantity n·∫øu mu·ªën ƒë·∫øm t·ªïng s·ªë l∆∞·ª£ng item con
                }
            });

            // C·∫≠p nh·∫≠t giao di·ªán
            selectedCountSpan.textContent = count + ' s·∫£n ph·∫©m';
            subtotalSpan.textContent = formatCurrency(total);
            finalTotalSpan.textContent = formatCurrency(total);
        }

        // 1. S·ª± ki·ªán Click "Ch·ªçn t·∫•t c·∫£"
        if(selectAllCheckbox){
            selectAllCheckbox.addEventListener('change', function() {
                itemCheckboxes.forEach(cb => {
                    cb.checked = selectAllCheckbox.checked;
                });
                updateSummary();
            });
        }

        // 2. S·ª± ki·ªán Click t·ª´ng checkbox l·∫ª
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                // N·∫øu b·ªè ch·ªçn 1 c√°i th√¨ b·ªè ch·ªçn "Select All"
                if (!cb.checked) {
                    selectAllCheckbox.checked = false;
                }
                // N·∫øu ch·ªçn h·∫øt th√¨ t·ª± tick "Select All"
                const allChecked = Array.from(itemCheckboxes).every(c => c.checked);
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                }
                updateSummary();
            });
        });

        // 3. X·ª≠ l√Ω n√∫t X√≥a (C·∫ßn k·∫øt n·ªëi v·ªõi Backend)
        // L∆∞u √Ω: ƒêo·∫°n n√†y gi·∫£ ƒë·ªãnh b·∫°n c√≥ file cart.js x·ª≠ l√Ω AJAX t∆∞∆°ng t·ª± n√∫t +/-
        // N·∫øu b·∫°n ch∆∞a c√≥ logic x√≥a h·∫≥n trong JS, b·∫°n c√≥ th·ªÉ th√™m class 'update-cart'
        // v√† th√™m data-action="delete" (c·∫ßn backend h·ªó tr·ª£) ho·∫∑c set quantity v·ªÅ 0.
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function(){
                const productId = this.dataset.product;
                console.log('X√≥a s·∫£n ph·∫©m ID:', productId);

                // G·ª≠i request x√≥a ·ªü ƒë√¢y. V√≠ d·ª• d√πng fetch ho·∫∑c g·ªçi h√†m updateUserOrder c√≥ s·∫µn
                // updateUserOrder(productId, 'delete_all');
            });
        });

        // 4. X·ª≠ l√Ω n√∫t Mua h√†ng
        checkoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedIds = [];
            itemCheckboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIds.push(cb.value);
                }
            });

            if (selectedIds.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
                return;
            }

            console.log('C√°c ID s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn:', selectedIds);
            // ·ªû ƒë√¢y b·∫°n c√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng sang trang checkout k√®m theo param
            // window.location.href = "/checkout/?items=" + selectedIds.join(',');
            // Ho·∫∑c submit form n·∫øu b·∫°n b·ªçc danh s√°ch trong th·∫ª <form>
            window.location.href = "{% url 'checkout' %}"; // Hi·ªán t·∫°i ƒëang ƒë·ªÉ m·∫∑c ƒë·ªãnh
        });

    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- C√ÅC H√ÄM C∆† B·∫¢N ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
        }

        // H√†m g·ªçi API updateItem (Copy logic fetch t·ª´ main.js n·∫øu b·∫°n ch∆∞a c√≥)
        function updateUserOrder(productId, action){
            var url = '/update_item/' // ƒê·∫£m b·∫£o URL n√†y kh·ªõp v·ªõi urls.py

            fetch(url, {
                method: 'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // L·∫•y token t·ª´ template
                },
                body:JSON.stringify({'productId':productId, 'action':action})
            })
            .then((response) => {
               return response.json();
            })
            .then((data) => {
                location.reload(); // Load l·∫°i trang sau khi x√≥a
            });
        }

        // --- DOM ELEMENTS ---
        const selectAllCheckbox = document.getElementById('select-all');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectedCountSpan = document.getElementById('selected-count');
        const subtotalSpan = document.getElementById('subtotal-price');
        const finalTotalSpan = document.getElementById('final-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const deleteButtons = document.querySelectorAll('.delete-cart-item');
        const updateButtons = document.querySelectorAll('.update-cart'); // N√∫t c·ªông tr·ª´

        // --- 1. X·ª¨ L√ù C·∫¨P NH·∫¨T GI√Å KHI CHECKBOX THAY ƒê·ªîI ---
        function updateSummary() {
            let total = 0;
            let count = 0;

            itemCheckboxes.forEach(cb => {
                if (cb.checked) {
                    const row = cb.closest('.item-row');
                    // L∆∞u √Ω: data-price c·∫ßn l√† s·ªë float chu·∫©n (kh√¥ng d·∫•u ph·∫©y ngƒÉn c√°ch ngh√¨n)
                    // ·ªû HTML, item.get_total render ra float, n√™n ta parse tr·ª±c ti·∫øp
                    const priceStr = row.getAttribute('data-price');
                    const price = parseFloat(priceStr);

                    total += price;
                    count += 1;
                }
            });

            selectedCountSpan.textContent = count + ' s·∫£n ph·∫©m';
            subtotalSpan.textContent = formatCurrency(total);
            finalTotalSpan.textContent = formatCurrency(total);
        }

        // Event: Ch·ªçn t·∫•t c·∫£
        if(selectAllCheckbox){
            selectAllCheckbox.addEventListener('change', function() {
                itemCheckboxes.forEach(cb => {
                    cb.checked = selectAllCheckbox.checked;
                });
                updateSummary();
            });
        }

        // Event: Ch·ªçn t·ª´ng c√°i
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!cb.checked) selectAllCheckbox.checked = false;
                const allChecked = Array.from(itemCheckboxes).every(c => c.checked);
                if (allChecked) selectAllCheckbox.checked = true;
                updateSummary();
            });
        });

        // --- 2. X·ª¨ L√ù N√öT X√ìA ---
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function(){
                const productId = this.dataset.product;
                // G·ªçi h√†m update v·ªõi action l√† 'delete'
                updateUserOrder(productId, 'delete');
            });
        });

        // X·ª≠ l√Ω n√∫t c·ªông tr·ª´ (n·∫øu ch∆∞a c√≥ trong main.js)
        updateButtons.forEach(btn => {
            btn.addEventListener('click', function(){
                const productId = this.dataset.product;
                const action = this.dataset.action;
                updateUserOrder(productId, action);
            })
        })

        // --- 3. X·ª¨ L√ù N√öT MUA H√ÄNG ---
        checkoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedIds = [];
            itemCheckboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIds.push(cb.value);
                }
            });

            if (selectedIds.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
                return;
            }

            // Chuy·ªÉn h∆∞·ªõng k√®m theo danh s√°ch ID
            // V√≠ d·ª•: /checkout/?items=1,5,9
            const url = "{% url 'checkout' %}?items=" + selectedIds.join(',');
            window.location.href = url;
        });

        // Ch·∫°y l·∫ßn ƒë·∫ßu ƒë·ªÉ t√≠nh to√°n ƒë√∫ng gi√° tr·ªã m·∫∑c ƒë·ªãnh
        updateSummary();
    });
</script>
{% endblock cart_content %}