{% extends 'app/base.html' %}
{% load static %}
{% load humanize %}  

{% block extra_css %}
<link href="{% static 'app/css/product_detail.css' %}" rel="stylesheet" />
<style>
    .bg-success-soft { background-color: #f0fff4; color: #2f855a; border: none; font-size: 0.7rem; padding: 4px 8px; }
    .bg-danger-soft { background-color: #fff5f5; color: #c53030; border: none; font-size: 0.7rem; padding: 4px 8px; }
    
    .review-item { padding: 1rem 0; border-bottom: 1px solid #f1f1f1; margin-bottom: 0.5rem; transition: all 0.3s ease; }
    .avatar-sm { width: 32px; height: 32px; background-color: #f0f2f5; color: #65676b; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 600; font-size: 0.8rem; }
    .review-user { font-size: 0.9rem; color: #050505; }
    .review-date { font-size: 0.75rem; color: #65676b; }
    .review-content { font-size: 0.85rem; color: #1c1e21; line-height: 1.4; margin-top: 2px; }

    .filter-btn { font-size: 0.8rem; border-radius: 20px; padding: 4px 15px; margin-right: 5px; border: 1px solid #ddd; background: #fff; transition: all 0.2s; }
    .filter-btn.active { background: #333; color: #fff; border-color: #333; }

    .new-comment-animate { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- CSS MỚI CHO SỬA/XÓA --- */
    .comment-actions { opacity: 0; transition: opacity 0.2s; }
    .review-item:hover .comment-actions { opacity: 1; }
    .action-link { font-size: 0.75rem; color: #65676b; cursor: pointer; margin-left: 10px; text-decoration: none; font-weight: 500; }
    .action-link:hover { text-decoration: underline; color: #0d6efd; }
    .action-link.delete:hover { color: #dc3545; }
    
    .edit-box { display: none; margin-top: 10px; }
    .edit-textarea { font-size: 0.85rem; border-radius: 8px; border: 1px solid #ddd; padding: 10px; width: 100%; margin-bottom: 8px; }

    
</style>
{% endblock extra_css %}

{% block main_content %}
<div class="container my-5">
    <h1 class="product-title fw-bold mb-3">{{ product.name }}</h1>
    <div class="product-header-info d-flex align-items-center mb-4">
        <div class="product-rating me-3">
            <i class="fas fa-star text-warning"></i> 4.9/5 (100 đánh giá)
        </div>
        <span class="text-muted">|</span>
        <span class="ms-3 text-success fw-bold">Còn hàng</span>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div class="product-gallery card p-3 mb-4 border-0">
                <img src="{{ product.ImageURL }}" class="img-fluid main-product-img" alt="{{ product.name }}">
            </div>
            <div class="tech-specs card p-4 border-0 shadow-sm">
                <h5 class="fw-bold mb-3">Thông số kỹ thuật</h5>
                <table class="table table-borderless table-sm">
                    <tbody>
                        <tr><th>Màn hình</th><td>6.7 inch, Dynamic AMOLED</td></tr>
                        <tr><th>Chip</th><td>{{ product.chip_model|default:"Apple A19 Bionic" }}</td></tr>
                        <tr><th>RAM</th><td>{{ product.ram_size|default:"8GB" }}</td></tr>
                        <tr><th>Pin</th><td>5000 mAh</td></tr>
                    </tbody>
                </table>
                <a href="#fullspecs-tab" class="btn btn-outline-dark btn-sm mt-2">Xem chi tiết cấu hình</a>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="config-selection mb-4">
                <h5 class="fw-bold mb-3">Chọn phiên bản:</h5>
                <div class="btn-group mb-3" role="group">
                    <input type="radio" class="btn-check" name="capacity" id="cap128" checked>
                    <label class="btn btn-outline-primary config-btn" for="cap128">128GB (Giá tốt nhất)</label>
                    <input type="radio" class="btn-check" name="capacity" id="cap256">
                    <label class="btn btn-outline-primary config-btn" for="cap256">256GB</label>
                    <input type="radio" class="btn-check" name="capacity" id="cap512">
                    <label class="btn btn-outline-primary config-btn" for="cap512">512GB</label>
                </div>

                <h6 class="fw-bold mt-2">Chọn màu:</h6>
                <div class="color-options d-flex">
                    <button class="color-dot me-2 active" style="background-color: #f75d59;"></button>
                    <button class="color-dot me-2" style="background-color: #000;"></button>
                    <button class="color-dot me-2" style="background-color: #f5f5dc;"></button>
                </div>
            </div>

            <div class="price-offer-box border p-4 rounded shadow-sm">
                <h3 class="price-sale text-danger display-5 fw-bold mb-0" id="product-price">
                    {{ product.price|floatformat:0|intcomma }}₫
                </h3>
                <div class="promotion-box p-3 mt-3 bg-light rounded text-secondary">
                    <h6 class="text-success mb-2 fw-bold"><i class="fas fa-gift me-2"></i> Ưu đãi & Quà tặng</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><i class="fas fa-check-circle text-success me-2"></i> Trả góp 0% hỗ trợ 12 tháng.</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i> Tặng voucher 500K mua phụ kiện.</li>
                    </ul>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-danger btn-lg update-cart fw-bold">MUA NGAY</button>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="product-tabs-section">
        <ul class="nav nav-tabs" id="productTab" role="tablist">
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#description">Mô tả</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fullspecs">Thông số</button></li>
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#reviews">Đánh giá & Bình luận</button></li>
        </ul>

        <div class="tab-content border border-top-0 p-4 bg-white" id="productTabContent">
            <div class="tab-pane fade" id="description" role="tabpanel">
                <p>{{ product.description|default:"Chưa có mô tả." }}</p>
            </div>

            <div class="tab-pane fade" id="fullspecs" role="tabpanel">
                <p>Thông số kỹ thuật chi tiết của sản phẩm...</p>
            </div>

            <div class="tab-pane fade show active" id="reviews" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 text-center border-end">
                        <h2 class="display-6 fw-bold text-dark mt-4">Phản hồi</h2>
                        <p class="text-muted small">Dựa trên ý kiến người dùng</p>
                    </div>

                    <div class="col-lg-8">
                        <div class="review-form mb-4" id="review-form-section">
                            <h6 class="mb-3 fw-bold">Viết bình luận</h6>
                            <form id="comment-form">
                                {% csrf_token %}
                                <div style="display:none;"><input type="text" name="honeypot" id="honeypot">
                                </div>
                                <textarea class="form-control mb-2" id="comment-content" rows="3" placeholder="Sản phẩm rất tuyệt..."></textarea>
                                <button type="submit" id="submit-review-btn" class="btn btn-warning btn-sm fw-bold px-4">Gửi đánh giá</button>
                            </form>
                        </div>

                        <hr>

                        <div class="d-flex align-items-center mb-3">
                            <span class="small fw-bold me-3">Lọc theo:</span>
                            <button class="filter-btn active" data-filter="all">Tất cả</button>
                            <button class="filter-btn" data-filter="pos">Tích cực</button>
                            <button class="filter-btn" data-filter="neg">Tiêu cực</button>
                        </div>

                        <div id="comment-list">
                            {% for review in product_reviews %}
                            <div class="review-item {% if forloop.counter > 3 %}d-none extra-review{% endif %}" 
                                 id="review-item-{{ review.id }}"
                                 data-sentiment="{% if review.sentiment == 1 %}pos{% else %}neg{% endif %}">
                                <div class="d-flex align-items-start">
                                    <div class="avatar-sm me-3">{{ review.user.username|slice:":1"|upper }}</div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="review-user fw-bold">{{ review.user.username }}</span>
                                                <small class="review-date text-muted ms-2">{{ review.date_added|date:"d/m/Y H:i" }}</small>
                                            </div>

                                            {% if review.user == request.user %}
                                            <div class="comment-actions">
                                                <span class="action-link" onclick="toggleEdit('{{ review.id }}')">Sửa</span>
                                                <span class="action-link delete" onclick="deleteComment('{{ review.id }}')">Xóa</span>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div id="content-box-{{ review.id }}">
                                            <p class="review-content text-secondary mb-1">
                                                {{ review.content }}
                                            </p>

                                            {% if review.ai_result %}
                                                {% for asp, sent in review.ai_result %}
                                                    <span class="badge rounded-pill ai-label
                                                        {% if sent == 'positive' %}
                                                            bg-success-soft
                                                        {% elif sent == 'negative' %}
                                                            bg-danger-soft
                                                        {% else %}
                                                            bg-secondary
                                                        {% endif %}
                                                    ">
                                                        {{ asp }}:
                                                        {% if sent == 'positive' %}Tích cực
                                                        {% elif sent == 'negative' %}Tiêu cực
                                                        {% else %}Trung lập
                                                        {% endif %}
                                                    </span>
                                                {% endfor %}
                                            {% endif %}
                                        </div>

                                        <div id="edit-box-{{ review.id }}" class="edit-box">
                                            <textarea class="edit-textarea" id="edit-input-{{ review.id }}">{{ review.content }}</textarea>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-dark btn-sm px-3" onclick="saveEdit('{{ review.id }}')">Lưu</button>
                                                <button class="btn btn-light btn-sm px-3" onclick="toggleEdit('{{ review.id }}')">Hủy</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p id="no-comment" class="text-muted small">Chưa có bình luận nào.</p>
                            {% endfor %}
                        </div>

                        {% if product_reviews|length > 3 %}
                        <div class="text-center mt-3" id="load-more-container">
                            <button class="btn btn-outline-dark btn-sm fw-bold px-4" id="load-more-btn" data-expanded="false">
                                Xem thêm <i class="fas fa-chevron-down ms-1"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const filterValue = this.getAttribute('data-filter');
        const items = document.querySelectorAll('.review-item');
        const loadMoreBtn = document.getElementById('load-more-btn');

        items.forEach((item, index) => {
            const itemSentiment = item.getAttribute('data-sentiment');
            if (filterValue === 'all') {
                if (index < 3) item.classList.remove('d-none');
                else item.classList.add('d-none');
                if (loadMoreBtn) loadMoreBtn.parentElement.classList.remove('d-none');
            } else {
                if (itemSentiment === filterValue) {
                    item.classList.remove('d-none');
                    item.classList.add('new-comment-animate');
                } else { item.classList.add('d-none'); }
                if (loadMoreBtn) loadMoreBtn.parentElement.classList.add('d-none');
            }
        });
    });
});

document.getElementById('load-more-btn')?.addEventListener('click', function() {
    const isExpanded = this.getAttribute('data-expanded') === 'true';
    const extraReviews = document.querySelectorAll('.extra-review');
    if (!isExpanded) {
        extraReviews.forEach(el => { el.classList.remove('d-none'); el.classList.add('new-comment-animate'); });
        this.innerHTML = 'Thu lại <i class="fas fa-chevron-up ms-1"></i>';
        this.setAttribute('data-expanded', 'true');
    } else {
        extraReviews.forEach(el => el.classList.add('d-none'));
        this.innerHTML = 'Xem thêm <i class="fas fa-chevron-down ms-1"></i>';
        this.setAttribute('data-expanded', 'false');
        document.getElementById('comment-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});

function toggleEdit(id) {
    const contentBox = document.getElementById(`content-box-${id}`);
    const editBox = document.getElementById(`edit-box-${id}`);
    const isEditing = editBox.style.display === 'block';
    
    editBox.style.display = isEditing ? 'none' : 'block';
    contentBox.style.display = isEditing ? 'block' : 'none';
}

function deleteComment(id) {
    if (!confirm("Bạn có chắc chắn muốn xóa bình luận này?")) return;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/delete-review/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const item = document.getElementById(`review-item-${id}`);
            item.style.transform = 'scale(0.95)';
            item.style.opacity = '0';
            setTimeout(() => item.remove(), 300);
        }
    });
}

function saveEdit(id) {
    const content = document.getElementById(`edit-input-${id}`).value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/edit-review/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ 'content': content })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const contentBox = document.getElementById(`content-box-${id}`);
            contentBox.querySelector('.review-content').innerText = data.content;
            
            const label = contentBox.querySelector('.ai-label');
            label.innerText = `AI: ${data.ai_sentiment}`;
            label.className = `badge rounded-pill ai-label ${data.ai_sentiment === 'Tích cực' ? 'bg-success-soft' : 'bg-danger-soft'}`;
            
            toggleEdit(id);
        }
    });
}

document.getElementById('comment-form')?.addEventListener('submit', function(e) {
    e.preventDefault(); 
    let contentInput = document.getElementById('comment-content');
    let submitBtn = document.getElementById('submit-review-btn');
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '...';

    fetch("", { 
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ 'content': contentInput.value, 'honeypot': document.getElementById('honeypot').value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    })
    .finally(() => { submitBtn.disabled = false; submitBtn.innerHTML = 'Gửi đánh giá'; });
});
</script>
{% endblock main_content %}