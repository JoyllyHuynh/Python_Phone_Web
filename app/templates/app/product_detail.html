{% extends 'app/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link href="{% static 'app/css/product_detail.css' %}" rel="stylesheet"/>
{% endblock extra_css %}

{% block main_content %}
<div class="container my-5">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="#">Điện thoại</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <h1 class="product-title fw-bold mb-3">{{ product.name }}</h1>

    <div class="product-header-info d-flex align-items-center mb-4">
        <div class="product-rating me-3">
        <i class="fas fa-star"></i>
        <span class="fw-bold" id="ai-header-score">
            {% if ai_overall %}{{ ai_overall }}{% else %}{{ product.average_rating|default:"0" }}{% endif %}
        </span>/5
        <span class="text-muted" id="ai-header-count">
            ({{ product_reviews|length }} đánh giá)
        </span>
        </div>


        <span class="divider">|</span>
        <span class="ms-3 sold-count">Đã bán: <b>{{ product.sold_count|default:"0" }}</b></span>
        <span class="divider mx-2">|</span>
        <span class="stock-status in-stock"><i class="fas fa-check-circle me-1"></i>Còn hàng</span>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="product-gallery card p-3 mb-4">
                <img src="{{ product.get_image_url }}" class="img-fluid main-product-img" alt="{{ product.name }}">
            </div>

            <div class="tech-specs card p-4">
                <h5 class="specs-title fw-bold mb-3">
                    <i class="fas fa-microchip me-2"></i>Thông số tóm tắt
                </h5>
                <table class="table table-borderless table-sm specs-table">
                    <tbody>
                    <tr>
                        <th><i class="fas fa-mobile-alt"></i> Màn hình</th>
                        <td>{{ product.screen_size|default:"Đang cập nhật" }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-microchip"></i> Chip</th>
                        <td>{{ product.chip|default:"Đang cập nhật" }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-memory"></i> RAM</th>
                        <td>{{ product.ram|default:"Đang cập nhật" }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-hdd"></i> Bộ nhớ</th>
                        <td>{{ product.storage|default:"Đang cập nhật" }}</td>
                    </tr>
                    <tr>
                        <th><i class="fas fa-battery-full"></i> Pin</th>
                        <td>{{ product.battery|default:"Đang cập nhật" }}</td>
                    </tr>
                    </tbody>
                </table>
                <a href="#fullspecs-tab" class="btn btn-view-specs btn-sm mt-2"
                   onclick="document.querySelector('#nav-specs-tab').click()">
                    <i class="fas fa-list-alt me-1"></i>Xem cấu hình chi tiết
                </a>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="product-info-card">
                <div class="config-selection mb-4">
                    <h5 class="section-title fw-bold mb-3">
                        <i class="fas fa-cog me-2"></i>Chọn phiên bản:
                    </h5>

                    {% if product.variants.all %}
                    <div class="variant-group mb-3" role="group">
                        {% for variant in product.variants.all %}
                        <input type="radio" class="btn-check variant-option"
                               name="variant_id"
                               id="var_{{ variant.id }}"
                               autocomplete="off"
                               data-price="{{ variant.price }}"
                               data-old-price="{{ variant.old_price|default_if_none:'0' }}"
                               {% if forloop.first %}checked{% endif %}>
                        <label class="config-btn" for="var_{{ variant.id }}">
                            <strong>{{ variant.storage_size }}</strong>
                        </label>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small">Sản phẩm này chỉ có một phiên bản duy nhất: <strong>{{ product.storage|default:"Tiêu chuẩn" }}</strong></p>
                    {% endif %}

                    <h6 class="section-title fw-bold mt-4 mb-3">
                        <i class="fas fa-palette me-2"></i>Màu sắc:
                    </h6>
                    <div class="color-options d-flex">
                        <button class="color-dot active" style="background-color: #1a1a2e;" title="Đen"></button>
                        <button class="color-dot" style="background-color: #e94560;" title="Đỏ"></button>
                        <button class="color-dot" style="background-color: #f5f5dc;" title="Kem"></button>
                        <button class="color-dot" style="background-color: #0f3460;" title="Xanh Navy"></button>
                    </div>
                </div>

                <div class="price-offer-box">
                    <div class="price-header d-flex align-items-center mb-2">
                        <span class="old-price" id="display-old-price" {% if not product.old_price %}style="display:none" {% endif %}>
                            {% if product.old_price %}{{ product.old_price|floatformat:0|intcomma }}₫{% endif %}
                        </span>
                        <span class="discount-badge ms-2" id="discount-badge"
                              {% if not product.old_price or product.price >= product.old_price %}style="display: none;"{% endif %}>
                            <i class="fas fa-tags me-1"></i>Giảm giá
                        </span>
                    </div>

                    <h3 class="price-sale fw-bold mb-0" id="display-price">
                        {{ product.price|floatformat:0|intcomma }}₫
                    </h3>

                    <div class="promotion-box mt-3">
                        <h6 class="promo-title mb-3">
                            <i class="fas fa-gift me-2"></i>Ưu đãi & Quà tặng
                        </h6>
                        <ul class="promo-list">
                            <li><i class="fas fa-check-circle"></i> Trả góp 0% lãi suất qua thẻ tín dụng</li>
                            <li><i class="fas fa-check-circle"></i> Thu cũ đổi mới trợ giá đến 2 triệu</li>
                            <li><i class="fas fa-check-circle"></i> Giảm thêm 5% cho thành viên VIP</li>
                            <li><i class="fas fa-check-circle"></i> Bảo hành chính hãng 12 tháng</li>
                        </ul>
                    </div>
                </div>

                <div class="action-buttons mt-4">
                    <button data-product="{{ product.id }}" data-action="add"
                            class="btn btn-add-cart update-cart fw-bold">
                        <i class="fas fa-cart-plus me-2"></i>THÊM VÀO GIỎ
                    </button>
                    <button id="buy-now-btn"
                            data-product="{{ product.id }}"
                            data-action="add"
                            class="btn btn-buy-now fw-bold">
                        <i class="fas fa-bolt me-2"></i>MUA NGAY
                    </button>
                </div>

                <div class="support-info mt-4">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="support-item">
                                <i class="fas fa-shipping-fast"></i>
                                <span>Giao hàng miễn phí</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="support-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>Bảo hành 12 tháng</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="support-item">
                                <i class="fas fa-sync-alt"></i>
                                <span>Đổi trả trong 7 ngày</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="support-item">
                                <i class="fas fa-headset"></i>
                                <span>Hỗ trợ 24/7</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="product-tabs-section mt-5">
        <ul class="nav nav-tabs" id="productTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#description">
                    <i class="fas fa-file-alt me-1"></i>Mô tả
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="nav-specs-tab" data-bs-toggle="tab" data-bs-target="#fullspecs">
                    <i class="fas fa-cogs me-1"></i>Thông số kỹ thuật
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#reviews">
                    <i class="fas fa-comments me-1"></i>Đánh giá ({{ product_reviews|length }})
                </button>
            </li>
        </ul>

        <div class="tab-content" id="productTabContent">
            <div class="tab-pane fade" id="description" role="tabpanel">
                <div class="content-description">
                    {{ product.description|default:"Sản phẩm này hiện chưa có bài viết mô tả chi tiết."|linebreaks }}
                </div>
            </div>

            <div class="tab-pane fade" id="fullspecs" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-10">
                        <table class="table specs-detail-table">
                            <tbody>
                            <tr>
                                <th><i class="fas fa-mobile-alt me-2"></i>Màn hình</th>
                                <td>{{ product.screen_size|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-camera me-2"></i>Camera sau</th>
                                <td>{{ product.rear_camera|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-camera-retro me-2"></i>Camera trước</th>
                                <td>{{ product.front_camera|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-microchip me-2"></i>Chip xử lý (CPU)</th>
                                <td>{{ product.chip|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-memory me-2"></i>RAM</th>
                                <td>{{ product.ram|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-hdd me-2"></i>Bộ nhớ trong</th>
                                <td>{{ product.storage|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-battery-full me-2"></i>Pin & Sạc</th>
                                <td>{{ product.battery|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-industry me-2"></i>Hãng sản xuất</th>
                                <td>{{ product.brand.name }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show active" id="reviews" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="rating-summary text-center">
                            <div class="rating-score">
                                {% if ai_overall %}
                                {{ ai_overall }}
                                {% else %}
                                {{ product.average_rating|default:"5.0" }}
                                {% endif %}
                            </div>

                            <div class="rating-stars mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>

                            <p class="rating-count">
                                {% if ai_overall %}
                                AI tổng hợp từ {{ product_reviews|length }} đánh giá
                                {% else %}
                                Dựa trên {{ product_reviews|length }} đánh giá
                                {% endif %}
                            </p>
                            </div>

                            <div id="feature-breakdown-box">
                                {% if aspect_stats %}
                                    <div class="card p-3 mt-3">
                                    <h6 class="fw-bold mb-3">Feature Breakdown</h6>

                                    <div class="d-grid gap-2">
                                        {% for asp, s in aspect_stats.items %}
                                        <div class="border rounded p-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                            <div class="fw-bold">{{ asp }}</div>
                                            <span class="badge
                                                {% if s.label == 'Mostly Positive' %}bg-success
                                                {% elif s.label == 'Mostly Negative' %}bg-danger
                                                {% elif s.label == 'Mixed' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {{ s.label }}
                                            </span>
                                            </div>

                                            <div class="small text-muted mt-1">
                                            {{ s.stars }}★ • {{ s.mentions }} mentions
                                            </div>

                                            <div class="progress mt-2" style="height:6px;">
                                            <div class="progress-bar bg-success" style="width: {{ s.pos_pct }}%"></div>
                                            <div class="progress-bar bg-danger" style="width: {{ s.neg_pct }}%"></div>
                                            <div class="progress-bar bg-secondary" style="width: {{ s.neu_pct }}%"></div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    </div>
                                {% endif %}
                                </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="review-form mb-4" id="review-form-section">
                            <h6 class="mb-3 fw-bold">
                                <i class="fas fa-pen me-2"></i>Viết bình luận
                            </h6>
                            <form id="comment-form" method="post" action="{% url 'add_review' product.id %}">
                                {% csrf_token %}
                                <div style="display:none;">
                                    <input type="text" name="honeypot" id="honeypot">
                                </div>

                                <textarea class="form-control mb-3"
                                        id="comment-content"
                                        name="content"
                                        rows="3"
                                        placeholder="Chia sẻ cảm nhận của bạn về sản phẩm..."
                                        required></textarea>

                                <!-- Turnstile đặt TRƯỚC nút submit -->
                                <div class="my-2 d-flex justify-content-center">
                                 <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITE_KEY }}"></div>
                                </div>

                                <button type="submit" id="submit-review-btn" class="btn btn-submit-review fw-bold">
                                    <i class="fas fa-paper-plane me-1"></i>Gửi đánh giá
                                </button>

                            </form>
                        </div>

                        <div class="filter-section d-flex align-items-center mb-3">
                            <span class="small fw-bold me-3">Lọc theo:</span>
                            <button class="filter-btn active" data-filter="all">Tất cả</button>
                            <button class="filter-btn" data-filter="pos">
                            <i class="fas fa-smile me-1"></i>Tích cực
                            </button>
                            <button class="filter-btn" data-filter="neg">
                            <i class="fas fa-frown me-1"></i>Tiêu cực
                            </button>
                            <button class="filter-btn" data-filter="neu">
                            <i class="fas fa-meh me-1"></i>Trung lập
                            </button>
                        </div>

                        <div id="comment-list">
                            {% for review in product_reviews %}
                            <div class="review-item {% if forloop.counter > 3 %}d-none extra-review{% endif %}"
                                id="review-item-{{ review.id }}"
                                data-sentiment="{% if review.sentiment == 1 %}pos{% elif review.sentiment == 0 %}neg{% else %}neu{% endif %}">

                                <div class="d-flex align-items-start">
                                    <div class="avatar-sm me-3">{{ review.user.username|slice:":1"|upper }}</div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="review-user fw-bold">{{ review.user.username }}</span>
                                                <small class="review-date text-muted ms-2">
                                                    {{ review.date_added|date:"d/m/Y H:i" }}
                                                </small>
                                            </div>
                                            {% if review.user == request.user %}
                                            <div class="comment-actions">
                                                <span class="action-link edit" onclick="toggleEdit('{{ review.id }}')">
                                                    <i class="fas fa-edit"></i> Sửa
                                                </span>
                                                <span class="action-link delete" onclick="deleteComment('{{ review.id }}')">
                                                    <i class="fas fa-trash"></i> Xóa
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div id="content-box-{{ review.id }}">
                                            <p class="review-content mb-2">{{ review.content }}</p>

                                            {% if review.ai_result %}
                                            <div class="ai-labels">
                                                {% for item in review.ai_result %}
                                                <span class="badge ai-label
                                                    {% if item.sentiment == 'Positive' %}positive
                                                    {% elif item.sentiment == 'Negative' %}negative
                                                    {% else %}neutral{% endif %}">
                                                    {{ item.aspect }}:
                                                    {% if item.sentiment == 'Positive' %}Tích cực
                                                    {% elif item.sentiment == 'Negative' %}Tiêu cực
                                                    {% else %}Trung lập{% endif %}
                                                    <small>({{ item.confidence|floatformat:2 }})</small>
                                                </span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div id="edit-box-{{ review.id }}" class="edit-box" style="display:none;">
                                            <textarea class="edit-textarea" id="edit-input-{{ review.id }}">{{ review.content }}</textarea>
                                            <div class="my-2">
                                                <div class="cf-turnstile" data-sitekey="{{ TURNSTILE_SITE_KEY }}"></div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-save-edit btn-sm" onclick="saveEdit('{{ review.id }}')">
                                                    <i class="fas fa-check me-1"></i>Lưu
                                                </button>
                                                <button class="btn btn-cancel-edit btn-sm" onclick="toggleEdit('{{ review.id }}')">
                                                    <i class="fas fa-times me-1"></i>Hủy
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% empty %}
                            <p id="no-comment" class="text-muted text-center py-4">
                                <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
                                Chưa có bình luận nào. Hãy là người đầu tiên đánh giá!
                            </p>
                            {% endfor %}
                        </div>

                        {% if product_reviews|length > 3 %}
                        <div class="text-center mt-3" id="load-more-container">
                            <button class="btn btn-load-more fw-bold" id="load-more-btn" data-expanded="false">
                                Xem thêm <i class="fas fa-chevron-down ms-1"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // ===== FILTER REVIEW =====
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      const filterValue = this.getAttribute('data-filter');
      const items = document.querySelectorAll('.review-item');
      const loadMoreBtn = document.getElementById('load-more-btn');

      items.forEach((item, index) => {
        const itemSentiment = item.getAttribute('data-sentiment');

        if (filterValue === 'all') {
          if (index < 3) item.classList.remove('d-none');
          else item.classList.add('d-none');

          if (loadMoreBtn) loadMoreBtn.parentElement.classList.remove('d-none');
        } else {
          if (itemSentiment === filterValue) item.classList.remove('d-none');
          else item.classList.add('d-none');

          if (loadMoreBtn) loadMoreBtn.parentElement.classList.add('d-none');
        }
      });
    });
  });

  // ===== LOAD MORE =====
  document.getElementById('load-more-btn')?.addEventListener('click', function () {
    const isExpanded = this.getAttribute('data-expanded') === 'true';
    const extraReviews = document.querySelectorAll('.extra-review');

    if (!isExpanded) {
      extraReviews.forEach(el => el.classList.remove('d-none'));
      this.innerHTML = 'Thu lại <i class="fas fa-chevron-up ms-1"></i>';
      this.setAttribute('data-expanded', 'true');
    } else {
      extraReviews.forEach(el => el.classList.add('d-none'));
      this.innerHTML = 'Xem thêm <i class="fas fa-chevron-down ms-1"></i>';
      this.setAttribute('data-expanded', 'false');
      document.getElementById('comment-list')?.scrollIntoView({behavior: 'smooth', block: 'start'});
    }
  });

  // ===== SUBMIT REVIEW (AJAX) =====
 document.getElementById("comment-form")?.addEventListener("submit", async function(e){
  e.preventDefault();

  const form = this;
  const content = (document.getElementById("comment-content")?.value || "").trim();
  if (!content) return;

  const csrfToken = document.querySelector("input[name=csrfmiddlewaretoken]")?.value;
  const turnstileToken = document.querySelector('input[name="cf-turnstile-response"]')?.value || "";
  const honeypotVal = document.getElementById("honeypot")?.value || "";

  if (!turnstileToken) {
    alert("Turnstile chưa sẵn sàng hoặc bị chặn. Đợi 1-2 giây rồi bấm lại.");
    return;
  }

  const resp = await fetch(form.action, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
      "X-CSRFToken": csrfToken,
    },
    body: new URLSearchParams({
      content,
      honeypot: honeypotVal,
      "cf-turnstile-response": turnstileToken,
    })
  });

  const data = await resp.json().catch(async () => {
    const t = await resp.text();
    return { ok: false, error: t.slice(0, 200) };
  });

  if (!resp.ok || !data.ok) {
    if (window.turnstile) window.turnstile.reset();
    alert(data.error || "Gửi thất bại");
    return;
  }

  document.getElementById("no-comment")?.remove();

  const list = document.getElementById("comment-list");
  if(list){
    list.insertAdjacentHTML("afterbegin", buildReviewHTML(data.review));
  }

  updateAiOverall(data.ai_overall, data.review_count);

  console.log("aspect_stats from server:", data.aspect_stats); // ✅ test
  if (data.aspect_stats) {
    const box = document.getElementById("feature-breakdown-box");
    if (box) box.innerHTML = ""; // ✅ clear để chắc chắn update
    renderBreakdown(data.aspect_stats);
  }

  document.getElementById("comment-content").value = "";
  if (window.turnstile) window.turnstile.reset();
});


  // ===== BUY NOW BUTTON (đưa vào trong DOMContentLoaded) =====
  const buyNowBtn = document.getElementById('buy-now-btn');
  if (buyNowBtn) {
    buyNowBtn.addEventListener('click', function (e) {
      e.preventDefault();
      const productId = this.getAttribute('data-product');
      const action = this.getAttribute('data-action');

      if (typeof user !== 'undefined' && user === 'AnonymousUser') {
        alert("Vui lòng đăng nhập để mua hàng!");
        window.location.href = "{% url 'login' %}?next={% url 'product_detail' product.id %}";
        return;
      }
      buyNowProduct(productId, action);
    });
  }

}); 

function buildReviewHTML(r){
  const sentimentKey = (r.sentiment === 1) ? "pos" : (r.sentiment === 0 ? "neg" : "neu");

  const badges = (r.ai_result || []).map(item => {
    const cls = item.sentiment === "Positive" ? "positive" : (item.sentiment === "Negative" ? "negative" : "neutral");
    const vn  = item.sentiment === "Positive" ? "Tích cực" : (item.sentiment === "Negative" ? "Tiêu cực" : "Trung lập");
    const conf = (item.confidence ?? 0).toFixed(2);
    return `<span class="badge ai-label ${cls}">
      ${item.aspect}: ${vn} <small>(${conf})</small>
    </span>`;
  }).join("");

  return `
  <div class="review-item" id="review-item-${r.id}" data-sentiment="${sentimentKey}">
    <div class="d-flex align-items-start">
      <div class="avatar-sm me-3">${(r.username||"U").slice(0,1).toUpperCase()}</div>
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="review-user fw-bold">${r.username}</span>
            <small class="review-date text-muted ms-2">${r.date_added}</small>
          </div>
          <div class="comment-actions">
            <span class="action-link edit" onclick="toggleEdit('${r.id}')">
              <i class="fas fa-edit"></i> Sửa
            </span>
            <span class="action-link delete" onclick="deleteComment('${r.id}')">
              <i class="fas fa-trash"></i> Xóa
            </span>
          </div>
        </div>

        <div id="content-box-${r.id}">
          <p class="review-content mb-2">${escapeHtml(r.content)}</p>
          <div class="ai-labels">${badges}</div>
        </div>

        <div id="edit-box-${r.id}" class="edit-box" style="display:none;">
          <textarea class="edit-textarea" id="edit-input-${r.id}">${escapeHtml(r.content)}</textarea>
          <div class="d-flex gap-2">
            <button class="btn btn-save-edit btn-sm" onclick="saveEdit('${r.id}')">
              <i class="fas fa-check me-1"></i>Lưu
            </button>
            <button class="btn btn-cancel-edit btn-sm" onclick="toggleEdit('${r.id}')">
              <i class="fas fa-times me-1"></i>Hủy
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>`;
}

function escapeHtml(str){
  return (str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function getCSRFToken(){
  return document.querySelector("input[name=csrfmiddlewaretoken]")?.value;
}

function toggleEdit(id){
  const editBox = document.getElementById(`edit-box-${id}`);
  const contentBox = document.getElementById(`content-box-${id}`);
  if(!editBox || !contentBox) return;

  const isHidden = (editBox.style.display === "none" || editBox.style.display === "");
  if(isHidden){
    editBox.style.display = "block";
    contentBox.style.display = "none";
    const ta = document.getElementById(`edit-input-${id}`);
    if(ta){ ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length); }
  }else{
    editBox.style.display = "none";
    contentBox.style.display = "block";
  }
}

async function deleteComment(id){
  if(!confirm("Xóa bình luận này?")) return;

  const csrf = getCSRFToken();
  const resp = await fetch(`/review/${id}/delete/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrf,
      "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
    },
    body: new URLSearchParams({})
  });

  const data = await resp.json();

  if(!resp.ok || !data.ok){
    alert(data.error || "Xóa thất bại");
    return;
  }

  // remove trước rồi mới tính count
  document.getElementById(`review-item-${id}`)?.remove();

  const count = document.querySelectorAll("#comment-list .review-item").length;
  updateAiOverall(data.ai_overall, count);
  renderBreakdown(data.aspect_stats);
}


async function saveEdit(id){
  const textarea = document.getElementById(`edit-input-${id}`);
  const newContent = (textarea?.value || "").trim();
  if(!newContent){ alert("Nội dung trống"); return; }

  // ✅ lấy token Turnstile (đúng name do Cloudflare tạo)
  const token =
    document.querySelector(`#edit-box-${id} input[name="cf-turnstile-response"]`)?.value ||
    document.querySelector(`input[name="cf-turnstile-response"]`)?.value ||
    "";

  if(!token){
    alert("Turnstile chưa sẵn sàng. Đợi 1-2 giây rồi bấm Lưu lại.");
    return;
  }

  const csrf = getCSRFToken();
  const resp = await fetch(`/review/${id}/edit/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrf,
      "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
    },
    body: new URLSearchParams({
      content: newContent,
      "cf-turnstile-response": token,   // ✅ GỬI TOKEN LÊN BACKEND
    })
  });

  const data = await resp.json();
  if(!resp.ok || !data.ok){
    alert(data.error || "Sửa thất bại");
    return;
  }

  // cập nhật text
  const contentP = document.querySelector(`#review-item-${id} .review-content`);
  if(contentP) contentP.textContent = data.review.content;

  // cập nhật badge AI
  const labelsBox = document.querySelector(`#review-item-${id} .ai-labels`);
  if(labelsBox){
    labelsBox.innerHTML = (data.review.ai_result || []).map(item => {
      const cls = item.sentiment === "Positive" ? "positive" : (item.sentiment === "Negative" ? "negative" : "neutral");
      const vn = item.sentiment === "Positive" ? "Tích cực" : (item.sentiment === "Negative" ? "Tiêu cực" : "Trung lập");
      const conf = (item.confidence ?? 0).toFixed(2);
      return `<span class="badge ai-label ${cls}">
        ${item.aspect}: ${vn} <small>(${conf})</small>
      </span>`;
    }).join("");
  }

  // cập nhật data-sentiment để filter đúng
  const itemDiv = document.getElementById(`review-item-${id}`);
  if(itemDiv){
    const s = data.review.sentiment;
    itemDiv.setAttribute("data-sentiment", s === 1 ? "pos" : (s === 0 ? "neg" : "neu"));
    updateAiOverall(data.ai_overall, document.querySelectorAll("#comment-list .review-item").length);
    renderBreakdown(data.aspect_stats);
  }

  // ✅ reset turnstile sau khi submit (tránh reuse token)
  if (window.turnstile) window.turnstile.reset();

  toggleEdit(id);
}


function updateAiOverall(ai_overall, reviewCount){
  // ===== update box rating-summary (tab review bên trái) =====
  const scoreEl = document.querySelector(".rating-summary .rating-score");
  const countEl = document.querySelector(".rating-summary .rating-count");

  if(scoreEl && ai_overall !== undefined && ai_overall !== null){
    scoreEl.textContent = ai_overall;
  }
  if(countEl && reviewCount !== undefined){
    countEl.textContent = `AI tổng hợp từ ${reviewCount} đánh giá`;
  }

  // ===== update header dưới tên sản phẩm =====
  const headerScore = document.getElementById("ai-header-score");
  const headerCount = document.getElementById("ai-header-count");

  if(headerScore && ai_overall !== undefined && ai_overall !== null){
    headerScore.textContent = ai_overall;
  }
  if(headerCount && reviewCount !== undefined){
    headerCount.textContent = `(${reviewCount} đánh giá)`;
  }
}


function renderBreakdown(aspect_stats){
  const box = document.getElementById("feature-breakdown-box");
  if(!box) return;

  // nếu không có stats -> ẩn
  if(!aspect_stats || Object.keys(aspect_stats).length === 0){
    box.innerHTML = "";
    return;
  }

  // dựng lại HTML giống bản compact bạn đang dùng
  let html = `
    <div class="card p-3 mt-3">
      <h6 class="fw-bold mb-3">Feature Breakdown</h6>
      <div class="d-grid gap-2">
  `;

  for(const asp in aspect_stats){
    const s = aspect_stats[asp];
    const label = s.label || "";
    let badgeClass = "bg-secondary";
    if(label === "Mostly Positive") badgeClass = "bg-success";
    else if(label === "Mostly Negative") badgeClass = "bg-danger";
    else if(label === "Mixed") badgeClass = "bg-warning text-dark";

    html += `
      <div class="border rounded p-2">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">${asp}</div>
          <span class="badge ${badgeClass}">${label}</span>
        </div>
        <div class="small text-muted mt-1">
          ${s.stars}★ • ${s.mentions} mentions
        </div>
        <div class="progress mt-2" style="height:6px;">
          <div class="progress-bar bg-success" style="width:${s.pos_pct}%;"></div>
          <div class="progress-bar bg-danger" style="width:${s.neg_pct}%;"></div>
          <div class="progress-bar bg-secondary" style="width:${s.neu_pct}%;"></div>
        </div>
      </div>
    `;
  }

  html += `</div></div>`;
  box.innerHTML = html;
}

    function buyNowProduct(productId, action) {
        const url = '/buy_now/';
        const csrftoken = getToken('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({'productId': productId, 'action': action})
        })
            .then(response => response.json())
            .then(data => {
                window.location.href = "{% url 'checkout' %}";
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Có lỗi xảy ra.");
            });
    }

    function getToken(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endblock main_content %}